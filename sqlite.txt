-- Get records from Home Assistant statistics
SELECT state, statistic_id AS entity_id, unit_of_measurement, datetime(start_ts, 'unixepoch') || ' GMT'
FROM statistics as st
JOIN statistics_meta as sm ON sm.id= st.metadata_id AND sm.statistic_id IN ('sensor.pg_mainhouse_total_energy_energy_hourly', 'sensor.pg_cube_total_energy_energy_hourly')
WHERE st.start_ts BETWEEN unixepoch('2025-08-21 06:00+02:00') AND unixepoch('2025-08-21 14:00+02:00')
ORDER BY st.id DESC

-- get values of entities from Home Assistant
-- Warning: datetime() with 'subsec' crops fractions to ms (microseconds are lost)
SELECT datetime(last_reported_ts, 'unixepoch', 'subsec') || ' GMT', sm.entity_id, state,  shared_attrs
FROM states AS st
JOIN states_meta as sm ON sm.metadata_id= st.metadata_id AND sm.entity_id IN ('sensor.pg_mainhouse_total_energy_energy_hourly', 'sensor.pg_cube_total_energy_energy_hourly')
JOIN state_attributes AS sa ON sa.attributes_id = st.attributes_id 
WHERE st.last_reported_ts BETWEEN unixepoch('2025-08-21 06:00+02:00') AND unixepoch('2025-08-21 14:00+02:00')
ORDER BY st.state_id

-- as above, but without conversion to datetime
SELECT last_reported_ts, sm.entity_id, state,  shared_attrs
FROM states AS st
JOIN states_meta as sm ON sm.metadata_id= st.metadata_id AND sm.entity_id IN ('sensor.pg_mainhouse_total_energy_energy_hourly', 'sensor.pg_cube_total_energy_energy_hourly')
JOIN state_attributes AS sa ON sa.attributes_id = st.attributes_id 
WHERE st.last_reported_ts > unixepoch('2025-08-24 13:41:08.395291+02:00')
ORDER BY st.state_id 

-- output to the sceen
sqlite3 -header -csv ./home-assistant_v2.db  < fetch_entities.sql

-- create table in pg
CREATE UNLOGGED TABLE import_from_ha (
	ts NUMERIC NOT NULL,
	entity_id TEXT NOT NULL,
	state TEXT NULL,
	shared_attrs TEXT NULL,
	CONSTRAINT pk PRIMARY KEY (ts, entity_id)
);

-- create `fetch_data.sql` file with query
SELECT last_reported_ts, sm.entity_id, state,  shared_attrs
FROM states AS st
JOIN states_meta as sm ON sm.metadata_id= st.metadata_id
JOIN state_attributes AS sa ON sa.attributes_id = st.attributes_id 
WHERE st.last_reported_ts BETWEEN unixepoch('2025-08-21 06:00+02:00') AND unixepoch('2025-08-21 14:00+02:00')
  AND sm.entity_id IN (...)
ORDER BY st.state_id

-- copy data directly from sqlite to pg
-- requires table for import
sqlite3 -header -csv ./home-assistant_v2.db < fetch_data.sql | docker exec -i addon_77b2833f_timescaledb psql -U postgres -d ha_timescale -c "COPY import_from_ha FROM STDIN WITH CSV HEADER"
